<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Watchbill Selection Assistant - Precision Scaling</title>
    <style>
        :root {
            --primary: #63b3ed;
            --secondary: #48bb78;
            --bg: #1a202c;
            --card-bg: #2d3748;
            --text: #f7fafc;
            --text-muted: #a0aec0;
            --warning: #f6ad55;
            --border: #4a5568;
            --gold: #f6e05e;
        }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 40px; background: var(--bg); color: var(--text); line-height: 1.6; }
        .container { max-width: 1200px; margin: auto; background: var(--card-bg); padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }

        #instructions { background: #2c5282; border-left: 5px solid var(--primary); padding: 20px; border-radius: 8px; margin-bottom: 30px; color: #ebf8ff; font-size: 0.9rem; }
        .upload-zone { border: 2px dashed var(--border); padding: 30px; text-align: center; border-radius: 8px; background: #2d3748; transition: 0.3s; }

        .controls-active { display: none; flex-direction: column; gap: 15px; margin-bottom: 20px; padding: 20px; background: #1a202c; border-radius: 8px; }

        .slider-container { flex-grow: 1; display: flex; flex-direction: column; gap: 4px; background: #2d3748; padding: 10px 20px; border-radius: 6px; border: 1px solid var(--border); transition: 0.3s; }
        .slider-row { display: flex; align-items: center; gap: 15px; width: 100%; }
        #biasSlider { flex-grow: 1; cursor: pointer; }

        .bias-label { font-weight: bold; color: var(--primary); min-width: 195px; font-size: 0.9rem; white-space: nowrap; transition: color 0.2s; }

        .sweet-spot-hint { font-size: 0.85rem; font-weight: 600; text-align: center; color: var(--text-muted); transition: 0.3s; margin-top: 2px; }
        .hint-active { color: var(--gold); text-shadow: 0 0 8px rgba(246, 224, 94, 0.3); }
        .container-glow { border-color: var(--gold) !important; box-shadow: 0 0 10px rgba(246, 224, 94, 0.2); }

        .input-row { display: flex; gap: 10px; align-items: center; width: 100%; }
        #searchInput { flex-grow: 1; padding: 10px; background: #2d3748; border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 0.95rem; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-top: 10px; }
        #filterControls { display: flex; gap: 8px; align-items: center; }
        .item-count { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; margin-left: 10px; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; display: none; table-layout: auto; }
        th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; }
        th { background: #2d3748; font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); }

        .sortable { cursor: pointer; user-select: none; transition: 0.2s; }
        .sortable:hover { color: var(--primary); background: #334155; }

        .name-flex { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .prob-val { opacity: 0; transition: opacity 0.2s ease-in-out; color: var(--primary); font-size: 0.8rem; font-weight: bold; white-space: nowrap; }
        td:hover .prob-val { opacity: 1; }

        .pt-cell { width: 1%; white-space: nowrap; transition: background 0.2s; }
        .pt-flex { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .pt-val { font-weight: bold; color: #1a202c; font-size: 1rem; min-width: 25px; text-align: center; }

        .pt-ctrl { display: flex; align-items: center; gap: 3px; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .pt-cell:hover .pt-ctrl { opacity: 1; }

        .btn-adj {
            width: 26px; height: 22px;
            border: 1px solid rgba(0,0,0,0.15);
            background: rgba(255,255,255,0.85);
            color: #1a202c;
            border-radius: 4px; cursor: pointer;
            font-size: 0.7rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-adj:hover { background: #fff; border-color: var(--primary); }

        .mod-row { border-left: 4px solid var(--warning); background: #3c362a !important; }

        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: 0.2s; }
        .btn-p { background: var(--primary); color: #1a202c; }
        .btn-s { background: var(--secondary); color: white; }
        .btn-w { background: var(--warning); color: #1a202c; }

        .notes-input { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 6px; background: #1a202c; color: white; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <h2>Watchbill Selection Assistant</h2>

    <div id="instructions">
        <p>Load the roster csv file with Name, Points, and Notes headers. Click <b>shuffle</b> to randomize the list.</p>
    </div>

    <div class="upload-zone" id="uploadZone">
        <input type="file" id="csvFile" accept=".csv" style="margin-bottom: 10px;"><br>
        <button class="btn btn-p" onclick="handleFileUpload()">Load Roster</button>
    </div>

    <div class="controls-active" id="activeControls">
        <div class="input-row">
            <input type="text" id="searchInput" placeholder="Search by name..." onkeyup="render()">
            <div class="slider-container" id="sliderBox">
                <div class="slider-row">
                    <span class="bias-label" id="biasDisplay">Bias: 1.6x (Balanced)</span>
                    <input type="range" id="biasSlider" min="1.0" max="10.0" step="0.1" value="1.6" oninput="render()">
                </div>
                <div id="sweetSpotHint" class="sweet-spot-hint">Sweet spot: 1.6x</div>
            </div>
        </div>
        <div class="top-bar">
            <div id="filterControls">
                <button class="btn btn-s" onclick="setFilter('all', this)">All</button>
                <button class="btn btn-p" onclick="setFilter('above', this)">Above Median</button>
                <button class="btn btn-p" onclick="setFilter('below', this)">Below/At Median</button>
                <span class="item-count" id="itemCount"></span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div id="statsDisplay" style="font-weight: bold; color: var(--primary); font-size: 0.9rem;"></div>
                <button class="btn btn-w" onclick="recalculate()">Shuffle</button>
                <button class="btn btn-s" id="downloadBtn">Download</button>
            </div>
        </div>
    </div>

    <table id="watchTable">
        <thead>
            <tr>
                <th class="sortable" onclick="sortTable('order')">Order ↕</th>
                <th class="sortable" onclick="sortTable('name')">NAME ↕</th>
                <th class="sortable" onclick="sortTable('Points')">Points ↕</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    let masterData = [];
    let headers = [];
    let currentFilter = 'all';
    let sortConfig = { key: null, dir: 1 };

    async function handleFileUpload() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return;

        const text = await file.text();
        const lines = text.split(/\r?\n/).filter(l => l.trim());
        headers = lines[0].split(',').map(h => h.trim());

        const rawData = lines.slice(1).map((line, idx) => {
            const values = line.split(',').map(v => v.trim());
            const obj = headers.reduce((acc, h, i) => ({...acc, [h]: values[i]}), {});
            const pointKey = Object.keys(obj).find(k => k.toLowerCase() === 'points');
            const noteKey = Object.keys(obj).find(k => k.toLowerCase() === 'notes');
            obj.Points = parseInt(obj[pointKey]) || 0;
            obj._originalPoints = obj.Points;
            obj.Notes = obj[noteKey] || '';
            obj.selectionRank = idx + 1;
            return obj;
        });

        masterData = rawData;
        document.getElementById('instructions').style.display = 'none';
        document.getElementById('uploadZone').style.display = 'none';
        document.getElementById('activeControls').style.display = 'flex';
        document.getElementById('watchTable').style.display = 'table';
        render();
    }

    function sortTable(key) {
        let targetKey;
        if (key === 'name') {
            targetKey = Object.keys(masterData[0]).find(k => k.toLowerCase() === 'name');
        } else if (key === 'Points') {
            targetKey = 'Points';
        } else if (key === 'order') {
            targetKey = 'selectionRank';
        }

        if (sortConfig.key === targetKey) {
            sortConfig.dir *= -1;
        } else {
            sortConfig.key = targetKey;
            sortConfig.dir = 1;
        }

        masterData.sort((a, b) => {
            let valA = a[targetKey];
            let valB = b[targetKey];
            if (typeof valA === 'string') return valA.localeCompare(valB) * sortConfig.dir;
            return (valA - valB) * sortConfig.dir;
        });
        render();
    }

    function setFilter(filterType, btnElement) {
        currentFilter = filterType;
        document.querySelectorAll('#filterControls .btn').forEach(btn => {
            btn.classList.add('btn-p'); btn.classList.remove('btn-s');
        });
        btnElement.classList.add('btn-s'); btnElement.classList.remove('btn-p');
        render();
    }

    function recalculate() {
        const targetT = parseFloat(document.getElementById('biasSlider').value);
        let pool = [...masterData];
        let pickedOrder = [];

        if (targetT === 1.0) {
            while (pool.length > 0) {
                let idx = Math.floor(Math.random() * pool.length);
                let person = pool.splice(idx, 1)[0];
                person.selectionRank = pickedOrder.length + 1;
                pickedOrder.push(person);
            }
        } else {
            const pts = masterData.map(d => d.Points);
            const minP = Math.min(...pts);
            const maxP = Math.max(...pts);
            let k = (maxP + 1 - targetT * (minP + 1)) / (targetT - 1);
            k = Math.max(-minP, k);

            while (pool.length > 0) {
                const weights = pool.map(p => p.Points + 1 + k);
                const totalWeight = weights.reduce((a, b) => a + b, 0);
                let r = Math.random() * totalWeight;
                let idx = 0;
                for (let i = 0; i < weights.length; i++) {
                    r -= weights[i];
                    if (r <= 0) { idx = i; break; }
                }
                let person = pool.splice(idx, 1)[0];
                person.selectionRank = pickedOrder.length + 1;
                pickedOrder.push(person);
            }
        }
        // Automatic reversal: high-point holders move to bottom
        masterData = pickedOrder.reverse();
        render();
    }

    function adjustPoints(indexInMaster, delta) {
        masterData[indexInMaster].Points = Math.max(0, masterData[indexInMaster].Points + delta);
        render();
    }

    function updateNote(indexInMaster, newNote) { masterData[indexInMaster].Notes = newNote; }

    function render() {
        const tbody = document.querySelector("#watchTable tbody");
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const targetT = parseFloat(document.getElementById('biasSlider').value);
        const biasDisplay = document.getElementById('biasDisplay');
        const hint = document.getElementById('sweetSpotHint');
        const box = document.getElementById('sliderBox');

        tbody.innerHTML = "";
        if (masterData.length === 0) return;

        // NEW: Refined range labels and cap at 10.0
        let labelText = `Bias: ${targetT.toFixed(1)}x `;
        if (targetT === 1.0) labelText += "(Random)";
        else if (targetT <= 1.7) labelText += "(Balanced)";
        else if (targetT <= 3.0) labelText += "(Strict)";
        else if (targetT <= 6.5) labelText += "(Intense)";
        else labelText += "(Near Absolute)";

        if (targetT === 1.6) {
            hint.classList.add('hint-active');
            box.classList.add('container-glow');
            biasDisplay.style.color = 'var(--gold)';
        } else {
            hint.classList.remove('hint-active');
            box.classList.remove('container-glow');
            biasDisplay.style.color = 'var(--primary)';
        }
        biasDisplay.innerText = labelText;

        const pts = masterData.map(d => d.Points);
        const minP = Math.min(...pts);
        const maxP = Math.max(...pts);

        let k = 0;
        let isRandomMode = (targetT === 1.0);
        if (!isRandomMode) {
            k = Math.max(-minP, (maxP + 1 - targetT * (minP + 1)) / (targetT - 1));
        }

        const totalWeightPool = isRandomMode ? masterData.length : masterData.reduce((sum, item) => sum + (item.Points + 1 + k), 0);
        const sortedPts = [...pts].sort((a, b) => a - b);
        let median = sortedPts.length % 2 === 0
            ? (sortedPts[sortedPts.length / 2 - 1] + sortedPts[sortedPts.length / 2]) / 2
            : sortedPts[Math.floor(sortedPts.length / 2)];

        const minProb = isRandomMode ? (1 / totalWeightPool) : ((minP + 1 + k) / totalWeightPool);
        const maxProb = isRandomMode ? (1 / totalWeightPool) : ((maxP + 1 + k) / totalWeightPool);

        let visibleCount = 0;
        masterData.forEach((item, masterIndex) => {
            const nameKey = Object.keys(item).find(k => k.toLowerCase() === 'name');
            if (searchTerm && !item[nameKey].toLowerCase().includes(searchTerm)) return;
            if (currentFilter === 'above' && item.Points <= median) return;
            if (currentFilter === 'below' && item.Points > median) return;

            visibleCount++;
            const row = tbody.insertRow();
            if (item.Points !== item._originalPoints) row.className = "mod-row";

            const weight = isRandomMode ? 1 : (item.Points + 1 + k);
            const odds = weight / totalWeightPool;
            const probPercent = (odds * 100).toFixed(1);

            let color = 'rgb(73, 253, 181)';
            if (maxProb !== minProb) {
                const ratio = (odds - minProb) / (maxProb - minProb);
                const g = Math.floor(253 + (145 - 253) * ratio);
                const b = Math.floor(181 + (253 - 181) * ratio);
                color = `rgb(73, ${g}, ${b})`;
            }

            row.innerHTML = `
                <td>${item.selectionRank}</td>
                <td>
                    <div class="name-flex">
                        <span>${item[nameKey]}</span>
                        <span class="prob-val">Odds: ${probPercent}% (W: ${weight.toFixed(1)})</span>
                    </div>
                </td>
                <td class="pt-cell" style="background-color: ${color}">
                    <div class="pt-flex">
                        <div class="pt-val">${item.Points}</div>
                        <div class="pt-ctrl">
                            <button class="btn-adj" onclick="adjustPoints(${masterIndex}, -1)">-1</button>
                            <button class="btn-adj" onclick="adjustPoints(${masterIndex}, 1)">+1</button>
                            <button class="btn-adj" onclick="adjustPoints(${masterIndex}, 3)">+3</button>
                            <button class="btn-adj" onclick="adjustPoints(${masterIndex}, 4)">+4</button>
                        </div>
                    </div>
                </td>
                <td><input type="text" class="notes-input" value="${item.Notes}" onchange="updateNote(${masterIndex}, this.value)"></td>
            `;
        });

        document.getElementById('itemCount').innerText = `Showing: ${visibleCount}`;
        document.getElementById('statsDisplay').innerText = `Median: ${median.toFixed(1)}`;

        document.getElementById('downloadBtn').onclick = () => {
            const sanitize = (val) => String(val).replace(/,/g, ';');
            const csvRows = [headers.join(',')];
            masterData.forEach(item => {
                const row = headers.map(h => sanitize(item[h] || ""));
                csvRows.push(row.join(','));
            });
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'watchbill_export.csv'; a.click();
        };
    }
</script>
</body>
</html>